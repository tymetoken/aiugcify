generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============ USER & AUTH ============

model User {
  id                    String    @id @default(cuid())
  email                 String    @unique
  passwordHash          String
  name                  String?
  creditBalance         Int       @default(0)
  stripeCustomerId      String?   @unique
  hasActiveSubscription Boolean   @default(false)
  isDeveloper           Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  lastLoginAt           DateTime?

  // Security: Account lockout after failed login attempts
  failedLoginAttempts   Int       @default(0)
  lockedUntil           DateTime?

  creditTransactions CreditTransaction[]
  videos             Video[]
  refreshTokens      RefreshToken[]
  subscription       Subscription?

  @@index([email])
  @@index([stripeCustomerId])
}

model RefreshToken {
  id        String    @id @default(cuid())
  token     String    @unique
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime  @default(now())
  revokedAt DateTime?

  @@index([userId])
  @@index([token])
}

// ============ CREDITS & PAYMENTS ============

enum TransactionType {
  PURCHASE
  CONSUMPTION
  REFUND
  BONUS
  ADJUSTMENT
  SUBSCRIPTION_CREDIT
  SUBSCRIPTION_BONUS
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  PAUSED
}

enum SubscriptionInterval {
  MONTHLY
  YEARLY
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model CreditTransaction {
  id              String            @id @default(cuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  type            TransactionType
  status          TransactionStatus @default(COMPLETED)
  amount          Int
  balanceAfter    Int
  stripeSessionId String?           @unique
  stripePaymentId String?
  packageId       String?
  priceInCents    Int?
  videoId         String?
  video           Video?            @relation(fields: [videoId], references: [id])
  description     String?
  metadata        Json?
  createdAt       DateTime          @default(now())

  @@index([userId])
  @@index([stripeSessionId])
  @@index([type])
  @@index([createdAt])
}

model CreditPackage {
  id            String   @id @default(cuid())
  name          String
  credits       Int
  priceInCents  Int
  stripePriceId String   @unique
  isActive      Boolean  @default(true)
  displayOrder  Int      @default(0)
  bonusCredits  Int      @default(0)
  badgeText     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([isActive])
}

model SubscriptionPlan {
  id                   String   @id @default(cuid())
  name                 String
  description          String?

  // Monthly pricing
  monthlyPriceInCents  Int
  monthlyStripePriceId String   @unique
  monthlyCredits       Int

  // Yearly pricing (with discount)
  yearlyPriceInCents   Int
  yearlyStripePriceId  String   @unique
  yearlyCredits        Int
  yearlyBonusCredits   Int      @default(0)

  // Features and display
  features             String[] @default([])
  isActive             Boolean  @default(true)
  displayOrder         Int      @default(0)
  badgeText            String?

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  subscriptions        Subscription[]

  @@index([isActive])
}

model Subscription {
  id                    String               @id @default(cuid())
  userId                String               @unique
  user                  User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Stripe subscription data
  stripeSubscriptionId  String               @unique
  stripePriceId         String

  // Subscription details
  planId                String
  plan                  SubscriptionPlan     @relation(fields: [planId], references: [id])
  status                SubscriptionStatus   @default(ACTIVE)
  interval              SubscriptionInterval

  // Billing cycle
  currentPeriodStart    DateTime
  currentPeriodEnd      DateTime
  cancelAtPeriodEnd     Boolean              @default(false)
  canceledAt            DateTime?

  // Credits tracking
  creditsPerPeriod      Int
  creditsUsedThisPeriod Int                  @default(0)
  lastCreditReset       DateTime             @default(now())

  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  @@index([stripeSubscriptionId])
  @@index([status])
}

// ============ VIDEO GENERATION ============

enum VideoStatus {
  PENDING_SCRIPT
  SCRIPT_READY
  QUEUED
  GENERATING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  EXPIRED
}

enum VideoStyle {
  PRODUCT_SHOWCASE
  TALKING_HEAD
  LIFESTYLE
}

enum Platform {
  TIKTOK_SHOP
  YOUTUBE_SHORTS
  FACEBOOK_REELS
  INSTAGRAM_REELS
  AMAZON
  SHOPIFY
}

model Video {
  id                 String      @id @default(cuid())
  userId             String
  user               User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  status             VideoStatus @default(PENDING_SCRIPT)
  platform           Platform    @default(TIKTOK_SHOP)

  // Product data (scraped from multiple platforms)
  productData        Json
  productTitle       String
  productUrl         String
  productImages      String[]
  productPrice       String?
  productDescription String?     @db.Text

  // Analyzed product data (from Product Breakdown GPT)
  analyzedProductData Json?
  masterProductSummary String?   @db.Text

  // Script
  generatedScript    String?     @db.Text
  editedScript       String?     @db.Text
  finalScript        String?     @db.Text

  // Video style
  videoStyle         VideoStyle  @default(PRODUCT_SHOWCASE)

  // Video generation
  soraJobId          String?     @unique
  soraModel          String?     @default("sora-2")
  videoDuration      Int?
  videoResolution    String?

  // Output
  cloudinaryPublicId String?
  cloudinaryUrl      String?
  downloadUrl        String?
  downloadExpiresAt  DateTime?
  thumbnailUrl       String?

  // Metadata
  creditsUsed        Int         @default(1)
  errorMessage       String?
  errorCode          String?
  retryCount         Int         @default(0)

  // Timestamps
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  scriptGeneratedAt  DateTime?
  generationStartedAt DateTime?
  completedAt        DateTime?

  creditTransactions CreditTransaction[]

  @@index([userId])
  @@index([status])
  @@index([platform])
  @@index([soraJobId])
  @@index([createdAt])
}

// ============ SYSTEM ============

model WebhookEvent {
  id          String    @id @default(cuid())
  provider    String
  eventId     String    @unique
  eventType   String
  payload     Json
  processed   Boolean   @default(false)
  processedAt DateTime?
  error       String?
  createdAt   DateTime  @default(now())

  @@index([eventId])
  @@index([processed])
}
